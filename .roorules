# OTAK Racking Tool - アーキテクチャ設計書

## プロジェクト概要
データセンター・サーバールーム向けのラック管理システム。
機器の配置、電源管理、冷却計算、ケーブル管理などの包括的な機能を提供。

## システムアーキテクチャ

```mermaid
classDiagram
    %% メインアプリケーション
    class App {
        -darkMode: boolean
        -zoomLevel: number
        -selectedRack: string
        -activeViewMode: string | null
        -currentPerspective: RackViewPerspective
        -racks: Record~string, Rack~
        -floorSettings: FloorSettings
        -selectedEquipment: Equipment | null
        -showEquipmentModal: boolean
        -showRackManager: boolean
        -showFloorSettings: boolean
        -showCoolingConfig: boolean
        -showPowerConfig: boolean
        -infoModal: InfoModalProps | null
        -confirmModal: ConfirmModalProps | null
        +render(): JSX.Element
        +handleDragStart(e: DragEvent, item: Equipment): void
        +handleDragOver(e: DragEvent): void
        +handleDrop(e: DragEvent, unit: number): void
        +showInfoModal(title: string, message: string): void
        +showConfirmModal(title: string, message: string, onConfirm: Function): void
    }

    %% 型定義
    class Equipment {
        +id: string
        +name: string
        +height: number
        +depth: number
        +power: number
        +heat: number
        +weight: number
        +type: EquipmentType
        +color: string
        +dualPower: boolean
        +airflow: string
        +cfm: number
        +heatGeneration: number
        +description: string
        +specifications?: Record~string, string~
        +mountingNotes?: string
        +startUnit?: number
        +endUnit?: number
        +isMainUnit?: boolean
        +pduType?: string
        +nutType?: string
        +screwType?: string
        +washerType?: string
        +requiresShelf?: boolean
        +system?: string
    }

    class Rack {
        +id: string
        +name: string
        +type: string
        +units: number
        +depth: number
        +width: number
        +equipment: Record~number, Equipment~
        +powerConnections: Record~string, PowerConnection~
        +mountingOptions: Record~string, MountingOption~
        +labels: Record~string, Label~
        +cageNuts: Record~number, CageNutConfig~
        +partInventory: Record~string, Equipment~
        +fans: FanConfig
        +position: Position
        +cabling: CablingConfig
        +housing: HousingConfig
        +environment: EnvironmentConfig
        +pduPlacements: PDUPlacement[]
        +physicalStructure: PhysicalStructure
    }

    class PhysicalStructure {
        +frame: RackFrame
        +frontDoor: RackDoor
        +rearDoor: RackDoor
        +leftPanel: SidePanel
        +rightPanel: SidePanel
        +mountingPosts: any
        +base: RackBase
        +top: RackTop
        +dimensions: any
        +weight: any
        +ventilation: any
    }

    class FloorSettings {
        +hasAccessFloor: boolean
        +floorHeight: number
        +tileSize: number
        +supportType: 'adjustable' | 'fixed' | 'string'
        +loadCapacity: 'light' | 'medium' | 'heavy'
        +cableRouting: any
    }

    %% コンポーネント階層
    class LeftSidebar {
        +darkMode: boolean
        +zoomLevel: number
        +activeViewMode: string | null
        +currentPerspective: RackViewPerspective
        +onZoomChange(zoom: number): void
        +onActiveViewModeChange(mode: string | null): void
        +onDragStart(e: DragEvent, item: any): void
        +onPerspectiveChange(perspective: RackViewPerspective): void
        +render(): JSX.Element
    }

    class RightSidebar {
        +racks: Record~string, Rack~
        +selectedRack: string
        +darkMode: boolean
        +floorSettings: FloorSettings
        +onRackSelect(rackId: string): void
        +onAddRack(): void
        +onRemoveRack(rackId: string): void
        +onDuplicateRack(rackId: string): void
        +onClearAllEquipment(): void
        +onShowRackManager(): void
        +onShowFloorSettings(): void
        +onShowCoolingConfig(): void
        +onShowPowerConfig(): void
        +render(): JSX.Element
    }

    class RackView {
        +rack: Rack
        +darkMode: boolean
        +zoomLevel: number
        +selectedRack: string
        +activeViewMode: string | null
        +perspective: RackViewPerspective
        +draggedItem?: Equipment | null
        +onDragOver?(e: DragEvent): void
        +onDrop?(e: DragEvent, unit: number): void
        +onEquipmentClick?(equipment: Equipment): void
        +onEquipmentRemove?(unit: number): void
        +onCageNutInstall?(unit: number, side: string, position: string, nutType: string): void
        +onCageNutRemove?(unit: number, side: string, position: string): void
        +onAutoInstallCageNuts?(unit: number, nutType: string): void
        +onUpdatePhysicalStructure?(updates: Partial~PhysicalStructure~): void
        +render(): JSX.Element
    }

    class RackUnit {
        +rack: Rack
        +unit: number
        +darkMode: boolean
        +zoomLevel: number
        +unitHeight: number
        +fontSize: number
        +activeViewMode: string | null
        +selectedRack: string
        +coolingStats: CoolingStats
        +render(): JSX.Element
    }

    class RackStructure {
        +rack: Rack
        +zoomLevel: number
        +unitHeight: number
        +perspective: RackViewPerspective
        +onUpdatePhysicalStructure?(updates: Partial~PhysicalStructure~): void
        +render(): JSX.Element
    }

    class RackPDU {
        +rack: Rack
        +zoomLevel: number
        +unitHeight: number
        +render(): JSX.Element
    }

    class MountingHoles {
        +rack: Rack
        +unit: number
        +zoomLevel: number
        +unitHeight: number
        +darkMode: boolean
        +perspective: 'front' | 'rear'
        +onCageNutInstall?(unit: number, side: string, position: string, nutType: string): void
        +onCageNutRemove?(unit: number, side: string, position: string): void
        +render(): JSX.Element
    }

    class EquipmentLibrary {
        +darkMode: boolean
        +onDragStart(e: DragEvent, item: Equipment): void
        +render(): JSX.Element
    }

    class ModalsAndDialogs {
        +darkMode: boolean
        +currentRack: Rack | null
        +selectedEquipment: Equipment | null
        +showEquipmentModal: boolean
        +racks?: Record~string, Rack~
        +showRackManager?: boolean
        +floorSettings?: FloorSettings
        +showFloorSettings?: boolean
        +showCoolingConfig?: boolean
        +showPowerConfig?: boolean
        +infoModal?: InfoModalProps | null
        +confirmModal?: ConfirmModalProps | null
        +onCloseEquipmentModal(): void
        +onUpdateLabel(equipmentId: string, field: string, value: string): void
        +onUpdatePowerConnection(equipmentId: string, field: string, value: any): void
        +onUpdateMountingOption(equipmentId: string, field: string, value: any): void
        +render(): JSX.Element
    }

    %% Hooks
    class useRackState {
        +racks: Record~string, Rack~
        +selectedRack: string
        +floorSettings: FloorSettings
        +currentRack: Rack
        +setSelectedRack(rackId: string): void
        +setFloorSettings(settings: FloorSettings): void
        +addRack(): void
        +removeRack(rackId: string): void
        +duplicateRack(rackId: string): void
        +updateRack(rackId: string, updates: Partial~Rack~): void
        +addEquipment(rackId: string, startUnit: number, equipment: Equipment): void
        +removeEquipment(rackId: string, unit: number): void
        +clearAllEquipment(rackId: string): void
        +updateLabel(rackId: string, equipmentId: string, field: string, value: string): void
        +updatePowerConnection(rackId: string, equipmentId: string, field: string, value: any): void
        +updateMountingOption(rackId: string, equipmentId: string, field: string, value: any): void
        +installCageNut(rackId: string, unit: number, side: string, position: string, nutType: string): void
        +removeCageNut(rackId: string, unit: number, side: string, position: string): void
        +autoInstallCageNutsForUnit(rackId: string, unit: number, nutType: string): void
        +updateEnvironment(rackId: string, field: string, value: number): void
    }

    class useDragAndDrop {
        +draggedItem: Equipment | null
        +handleDragStart(e: DragEvent, item: Equipment): void
        +handleDragOver(e: DragEvent): void
        +handleDrop(e: DragEvent, startUnit: number): void
        +handleDragEnd(): void
        +setDraggedItem(item: Equipment | null): void
    }

    %% サービス層
    class EquipmentPlacementManager {
        -constraints: PlacementConstraint[]
        +placeEquipment(rack: Rack, startUnit: number, equipment: Equipment, options?: PlacementOptions): Promise~PlacementResult~
        +removeEquipment(rack: Rack, unit: number): Promise~PlacementResult~
        +clearAllEquipment(rack: Rack): Promise~PlacementResult~
        +validatePlacement(context: PlacementContext): Promise~PlacementValidation~
        +getRackOccupancy(rack: Rack): RackOccupancy
        -executePlacement(context: PlacementContext): Promise~PlacementChange[]~
        -initializeConstraints(): void
        -createUnitRangeConstraint(): PlacementConstraint
        -createCapacityConstraint(): PlacementConstraint
        -createOccupancyConstraint(): PlacementConstraint
        -createShelfRequirementConstraint(): PlacementConstraint
        -createCageNutConstraint(): PlacementConstraint
        -calculateTotalWeight(rack: Rack): number
        -getRackMaxWeight(rack: Rack): number
        -hasCompleteCageNuts(rack: Rack, unit: number): boolean
        -createCompleteCageNutConfig(nutType: string): any
    }

    class PlacementConstraint {
        +id: string
        +name: string
        +priority: number
        +validate(rack: Rack, position: PlacementPosition, equipment: Equipment): PlacementValidation
    }

    class PlacementResult {
        +success: boolean
        +position?: PlacementPosition
        +validation: PlacementValidation
        +appliedChanges: PlacementChange[]
        +updatedRack?: Rack
    }

    class PlacementValidation {
        +isValid: boolean
        +errors: PlacementError[]
        +warnings: PlacementWarning[]
    }

    %% ユーティリティ
    class LocalStorageUtils {
        +loadAppState(): Partial~AppState~
        +saveAppState(state: Partial~AppState~): void
        +clearAppState(): void
        +getStorageSize(): string
        +getStorageInfo(): any
    }

    class UtilityFunctions {
        +calculateTotalStats(racks: Record~string, Rack~): TotalStats
        +calculateRackStats(rack: Rack): RackStats
        +calculateCoolingStats(rack: Rack): CoolingStats
        +canPlaceEquipment(rack: Rack, startUnit: number, equipment: Equipment): any
        +getCageNutStatus(unit: number, rack: Rack): CageNutStatus
        +getPowerStatus(equipment: Equipment, powerConnections: any): any
        +getEquipmentDisplayName(equipment: Equipment, labels: any): string
        +deepCopy~T~(obj: T): T
        +autoInstallCageNuts(unit: number, nutType: string): any
        +getPowerSources(rack: Rack): PowerSources
        +getZoomedUnitHeight(zoomLevel: number): number
        +getZoomedFontSize(zoomLevel: number): number
    }

    %% アイコンコンポーネント
    class RackIcons {
        +getEquipmentIcon(type: string, size: number): JSX.Element
        +getAirflowIcon(airflow: string, size: number): JSX.Element
        +getMountingIcon(mountingType: string, needsRails: boolean, size: number): JSX.Element
    }

    %% 関係性の定義
    App *-- "1" useRackState : uses
    App *-- "1" useDragAndDrop : uses
    App *-- "1" LeftSidebar : contains
    App *-- "1" RightSidebar : contains
    App *-- "1" RackView : contains
    App *-- "1" ModalsAndDialogs : contains

    RackView *-- "0..*" RackUnit : contains
    RackView *-- "1" RackStructure : contains
    RackView *-- "1" RackPDU : contains

    RackUnit *-- "1" MountingHoles : contains
    RackUnit ..> RackIcons : uses

    LeftSidebar *-- "1" EquipmentLibrary : contains

    useRackState ..> EquipmentPlacementManager : uses
    useRackState ..> LocalStorageUtils : uses

    useDragAndDrop ..> UtilityFunctions : uses

    EquipmentPlacementManager *-- "0..*" PlacementConstraint : contains
    EquipmentPlacementManager ..> PlacementResult : creates
    EquipmentPlacementManager ..> PlacementValidation : creates

    Rack *-- "0..*" Equipment : contains
    Rack *-- "1" PhysicalStructure : contains
    Rack ..> FloorSettings : references

    %% 重要な依存関係
    App ..> Rack : manages
    App ..> Equipment : handles
    App ..> FloorSettings : configures

    note for App "メインアプリケーション\n状態管理とイベントハンドリング"
    note for EquipmentPlacementManager "機器配置の制約チェックと実行\n複雑なビジネスロジックを担当"
    note for useRackState "ラック状態管理\nLocalStorage連携"
    note for Rack "ラックの完全な状態表現\n物理構造から論理設定まで"
```

## 主要設計パターン

### 1. コンポーネント構成
- **プレゼンテーション層**: UI表示とユーザー操作
- **ビジネスロジック層**: EquipmentPlacementManager
- **データ層**: LocalStorage + useRackState

### 2. 状態管理
- **React Hooks**: useRackState, useDragAndDrop
- **Immutable Updates**: 状態の不変性を保持
- **LocalStorage**: 永続化

### 3. 制約システム
- **PlacementConstraint**: 機器配置の制約を定義
- **Priority-based Validation**: 優先度順での制約チェック
- **Error/Warning System**: エラーと警告の分離

### 4. 型安全性
- **TypeScript**: 完全な型定義
- **インターフェース分離**: 明確な責務分担
- **ジェネリック**: 再利用可能なユーティリティ

## 拡張ポイント

1. **新しい機器タイプ**: Equipment型の拡張
2. **新しい制約**: PlacementConstraint実装
3. **新しい表示モード**: activeViewModeの追加
4. **新しいラックタイプ**: rackTypesの拡張
5. **新しい物理構造**: PhysicalStructureの拡張

## パフォーマンス考慮

1. **メモ化**: React.memo, useMemo, useCallback
2. **遅延ローディング**: 大規模データの段階的読み込み
3. **仮想スクロール**: 大量機器の効率的表示
4. **状態最適化**: 必要最小限の再レンダリング